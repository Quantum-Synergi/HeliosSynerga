<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helios Synerga | LIVE Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cruip-bg: #0b0e1b;
      --cruip-card: rgba(15, 23, 43, 0.75);
      --cruip-glass: rgba(255, 255, 255, 0.03);
      --cruip-border: rgba(255, 255, 255, 0.08);
      --cruip-text: #e6eaf2;
      --cruip-muted: #98a2b8;
      --cruip-green: #2dd4bf;
      --cruip-red: #fb7185;
      --cruip-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --radius-xl: 20px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      min-height: 100%;
      background: radial-gradient(circle at 15% 10%, #1a2444 0%, var(--cruip-bg) 40%, #080b14 100%);
      color: var(--cruip-text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dashboard {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 2rem;
      padding: 1.5rem;
    }

    .glass-panel {
      background: var(--cruip-card);
      border: 1px solid var(--cruip-border);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      flex-wrap: wrap;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      font-size: 1.1rem;
    }

    .brand-highlight {
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.35);
      font-weight: 800;
    }

    .project-id-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      border: 1px solid rgba(255, 255, 255, 0.55);
      color: #ffffff;
      background: rgba(255, 255, 255, 0.08);
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.75);
      font-size: 0.74rem;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .live-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border: 1px solid rgba(45, 212, 191, 0.45);
      color: #99f6e4;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(45, 212, 191, 0.08);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--cruip-green);
      box-shadow: 0 0 0 8px rgba(45, 212, 191, 0.12);
    }

    .header-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-stat {
      min-width: 150px;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--cruip-border);
      background: var(--cruip-glass);
    }

    .label {
      color: var(--cruip-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.66rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .header-value {
      font-weight: 800;
      font-size: 1.15rem;
      line-height: 1;
    }

    .main-grid {
      display: grid;
      grid-template-rows: minmax(420px, 50%) minmax(260px, 25%) minmax(260px, 25%);
      gap: 1.25rem;
      min-height: 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 1.25rem;
      min-height: 0;
    }

    .chart-card {
      background: var(--cruip-card);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
      border: 1px solid var(--cruip-border);
      display: flex;
      flex-direction: column;
      padding: 0.95rem;
      min-height: 0;
    }

    .chart-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
    }

    .chart-title {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .chart-subtitle {
      color: var(--cruip-muted);
      font-size: 0.72rem;
      font-weight: 500;
    }

    .chart-canvas-wrap {
      height: 400px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      overflow: hidden;
      background: #0d1222;
    }

    .chart-canvas-wrap canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr));
      gap: 0.85rem;
    }

    .metric-card {
      background: var(--cruip-card);
      border: 1px solid var(--cruip-border);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
      padding: 0.85rem;
      min-height: 112px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
    }

    .metric-value {
      font-size: clamp(1.05rem, 1.8vw, 1.6rem);
      font-weight: 800;
      line-height: 1.1;
    }

    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      min-height: 0;
    }

    .table-card {
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .table-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--cruip-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.65rem;
    }

    .table-wrap {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: rgba(11, 16, 32, 0.7);
      overflow: auto;
      flex: 1;
      min-height: 190px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.76rem;
    }

    th,
    td {
      text-align: left;
      padding: 0.55rem 0.55rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      white-space: nowrap;
    }

    th {
      color: var(--cruip-muted);
      font-size: 0.63rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      position: sticky;
      top: 0;
      background: rgba(8, 12, 24, 0.96);
      z-index: 1;
    }

    .pnl-pos { color: var(--cruip-green); }
    .pnl-neg { color: var(--cruip-red); }

    .status-pill {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid var(--cruip-border);
      padding: 0.15rem 0.48rem;
      font-size: 0.64rem;
      color: #cfd7e8;
      background: rgba(255, 255, 255, 0.03);
    }

    .status-open {
      color: #99f6e4;
      border-color: rgba(45, 212, 191, 0.55);
      background: rgba(45, 212, 191, 0.14);
    }

    .status-closed {
      color: #fecdd3;
      border-color: rgba(251, 113, 133, 0.55);
      background: rgba(251, 113, 133, 0.14);
    }

    .forum-pill-post {
      color: #bfdbfe;
      border-color: rgba(59, 130, 246, 0.55);
      background: rgba(59, 130, 246, 0.15);
    }

    .forum-pill-comment {
      color: #fde68a;
      border-color: rgba(250, 204, 21, 0.55);
      background: rgba(250, 204, 21, 0.15);
    }

    .footer {
      text-align: center;
      color: var(--cruip-muted);
      font-size: 0.78rem;
      padding-bottom: 0.5rem;
    }

    .sync-line {
      margin-top: 0.35rem;
      font-size: 0.72rem;
      color: #90a0bc;
    }

    .heartbeat-line {
      margin-top: 0.25rem;
      font-size: 0.72rem;
      color: #97a8c8;
    }

    .footer a {
      color: #b8c3dc;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 1280px) {
      .metrics-grid {
        grid-template-columns: repeat(3, minmax(130px, 1fr));
      }

      .main-grid {
        grid-template-rows: auto auto auto;
      }
    }

    @media (max-width: 980px) {
      .dashboard {
        padding: 1rem;
        gap: 1rem;
      }

      .charts-grid,
      .bottom-grid {
        grid-template-columns: 1fr;
      }

      .chart-canvas-wrap {
        height: 320px;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, minmax(130px, 1fr));
      }

      .header-stat {
        min-width: 130px;
      }
    }

    @media (max-width: 620px) {
      .header {
        align-items: flex-start;
      }

      .header-stats {
        width: 100%;
      }

      .header-stat {
        width: 100%;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <header class="header glass-panel">
      <div class="header-brand">
        <span class="brand-highlight">HeliosSynerga</span>
        <span class="project-id-pill">Project ID 621</span>
        <span class="live-pill"><span class="live-dot"></span>LIVE</span>
      </div>
      <div class="header-stats">
        <div class="header-stat">
          <div class="label">Real P&amp;L</div>
          <div id="headerPnL" class="header-value">+0.0000 SOL</div>
        </div>
        <div class="header-stat">
          <div class="label">Wallet Balance</div>
          <div id="headerWalletBalance" class="header-value">0.0000 SOL</div>
        </div>
        <div class="header-stat">
          <div class="label">Real Votes</div>
          <div id="headerVotes" class="header-value">0</div>
        </div>
      </div>
    </header>

    <section class="main-grid">
      <section class="charts-grid">
        <article class="chart-card">
          <div class="chart-head">
            <div class="chart-title">BTCUSDT</div>
            <div class="chart-subtitle">Real trade ticks</div>
          </div>
          <div class="chart-canvas-wrap">
            <canvas id="btcChart"></canvas>
          </div>
        </article>
        <article class="chart-card">
          <div class="chart-head">
            <div class="chart-title">SOLUSDT</div>
            <div class="chart-subtitle">Real trade ticks</div>
          </div>
          <div class="chart-canvas-wrap">
            <canvas id="solChart"></canvas>
          </div>
        </article>
        <article class="chart-card">
          <div class="chart-head">
            <div class="chart-title">Profit Over Time</div>
            <div class="chart-subtitle">Cumulative P&amp;L (SOL)</div>
          </div>
          <div class="chart-canvas-wrap">
            <canvas id="profitChart"></canvas>
          </div>
        </article>
      </section>

      <section class="metrics-grid">
        <article class="metric-card">
          <div class="label">PnL</div>
          <div id="cardPnL" class="metric-value">+0.0000 SOL</div>
        </article>
        <article class="metric-card">
          <div class="label">Win Rate</div>
          <div id="cardWinRate" class="metric-value">0.0%</div>
        </article>
        <article class="metric-card">
          <div class="label">Sharpe</div>
          <div id="cardSharpe" class="metric-value">0.00</div>
        </article>
        <article class="metric-card">
          <div class="label">Total Trades</div>
          <div id="cardTotalTrades" class="metric-value">0</div>
        </article>
        <article class="metric-card">
          <div class="label">Winning Trades</div>
          <div id="cardWinningTrades" class="metric-value">0</div>
        </article>
        <article class="metric-card">
          <div class="label">Vote Count</div>
          <div id="cardVotes" class="metric-value">0</div>
        </article>
        <article class="metric-card">
          <div class="label">Wallet Allowance</div>
          <div id="cardWalletAllowance" class="metric-value">0.0000 SOL</div>
        </article>
        <article class="metric-card">
          <div class="label">Wallet Balance</div>
          <div id="cardWalletBalance" class="metric-value">0.0000 SOL</div>
        </article>
        <article class="metric-card">
          <div class="label">Wallet ROI</div>
          <div id="cardWalletRoi" class="metric-value">0.00%</div>
        </article>
        <article class="metric-card">
          <div class="label">Trade Volume</div>
          <div id="cardTradeVolume" class="metric-value">0.0000 SOL</div>
        </article>
        <article class="metric-card">
          <div class="label">Avg PnL / Trade</div>
          <div id="cardAvgPnl" class="metric-value">+0.0000 SOL</div>
        </article>
      </section>

      <section class="bottom-grid">
        <article class="table-card glass-panel">
          <h3 class="table-title">Positions</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Symbol</th>
                  <th>Strategy</th>
                  <th>Size</th>
                  <th>PnL</th>
                  <th>Status</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="positionsBody"></tbody>
            </table>
          </div>
        </article>

        <article class="table-card glass-panel">
          <h3 class="table-title">Forum Conversations</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Reference</th>
                  <th>Message</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="forumBody"></tbody>
            </table>
          </div>
        </article>
      </section>
    </section>

    <footer class="footer">
      Technical details:
      <a href="https://github.com/Quantum-Synergi/HeliosSynerga" target="_blank" rel="noopener noreferrer">https://github.com/Quantum-Synergi/HeliosSynerga</a>
      <div id="apiSyncStatus" class="sync-line">API sync: connecting...</div>
      <div id="heartbeatStatus" class="heartbeat-line">Heartbeat: connecting...</div>
    </footer>
  </main>

  <script>
    let lastApiSync = null;
    let resolvedApiBase = null;
    let apiBaseResolutionPromise = null;

    function inferForwardedOriginsFromHost(hostname) {
      const match = hostname.match(/^(.*)-(\d+)\.app\.github\.dev$/);
      if (!match) return [];
      const prefix = match[1];
      return [
        `https://${prefix}-4000.app.github.dev`,
        `https://${prefix}-4010.app.github.dev`,
        `https://${prefix}-4020.app.github.dev`,
        `https://${prefix}-4030.app.github.dev`,
        `https://${prefix}-4040.app.github.dev`
      ];
    }

    async function resolveApiBase() {
      if (resolvedApiBase) return resolvedApiBase;
      if (apiBaseResolutionPromise) return apiBaseResolutionPromise;

      apiBaseResolutionPromise = (async () => {
        const currentOrigin = window.location.origin;
        const hostCandidates = inferForwardedOriginsFromHost(window.location.hostname);
        const localCandidates = [
          'http://localhost:4000',
          'http://127.0.0.1:4000',
          'http://localhost:4010',
          'http://localhost:4020',
          'http://localhost:4030',
          'http://localhost:4040'
        ];
        const candidates = [currentOrigin, ...hostCandidates, ...localCandidates]
          .filter((value, index, array) => value && array.indexOf(value) === index);

        for (const origin of candidates) {
          try {
            const response = await fetch(`${origin}/api/health`, {
              cache: 'no-store',
              mode: 'cors'
            });

            if (!response.ok) {
              continue;
            }

            const payload = await response.json().catch(() => null);
            if (payload?.ok === true && payload?.service === 'heliossynerga-dashboard-api') {
              resolvedApiBase = origin;
              return origin;
            }
          } catch {
            // continue
          }
        }

        resolvedApiBase = currentOrigin;
        return resolvedApiBase;
      })();

      return apiBaseResolutionPromise;
    }

    function buildApiUrl(path) {
      const normalized = path.startsWith('/') ? path : `/${path}`;
      const base = resolvedApiBase || window.location.origin;
      return `${base}${normalized}`;
    }

    function formatSigned(value) {
      const number = Number(value || 0);
      const sign = number >= 0 ? '+' : '';
      return `${sign}${number.toFixed(4)}`;
    }

    function formatPercent(value) {
      return `${Number(value || 0).toFixed(2)}%`;
    }

    function computeSharpe(trades) {
      if (!trades.length) return 0;
      const returns = trades.map((trade) => Number(trade.pnl || 0));
      const mean = returns.reduce((sum, value) => sum + value, 0) / returns.length;
      const variance = returns.reduce((sum, value) => sum + ((value - mean) ** 2), 0) / returns.length;
      const stdDev = Math.sqrt(variance);
      if (!stdDev) return 0;
      return (mean / stdDev) * Math.sqrt(returns.length);
    }

    function mapSymbol(strategy) {
      return strategy === 'liquidity' ? 'SOLUSDT' : 'BTCUSDT';
    }

    function buildCandlesFromTrades(trades, symbol) {
      const strategyFilter = symbol === 'SOLUSDT'
        ? (trade) => trade.strategy === 'liquidity'
        : (trade) => trade.strategy !== 'liquidity';

      const selected = trades
        .filter(strategyFilter)
        .slice()
        .reverse();

      if (!selected.length) return [];

      let level = 100;
      const points = selected.map((trade, index) => {
        level += Number(trade.pnl || 0) * 10000;
        return {
          x: index,
          y: level,
          timestamp: trade.timestamp
        };
      });

      const candles = [];
      const step = 3;
      for (let index = 0; index < points.length; index += step) {
        const slice = points.slice(index, index + step);
        const open = slice[0].y;
        const close = slice[slice.length - 1].y;
        const high = Math.max(...slice.map((entry) => entry.y));
        const low = Math.min(...slice.map((entry) => entry.y));
        candles.push({
          open,
          close,
          high,
          low,
          label: new Date(slice[slice.length - 1].timestamp).toLocaleTimeString()
        });
      }

      return candles.slice(-40);
    }

    function drawCandles(canvasId, candles) {
      const canvas = document.getElementById(canvasId);
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext('2d');
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      const width = rect.width;
      const height = rect.height;

      ctx.fillStyle = '#0d1222';
      ctx.fillRect(0, 0, width, height);

      if (!candles.length) {
        ctx.fillStyle = '#98a2b8';
        ctx.font = '13px Inter';
        ctx.fillText('No trade ticks yet', 16, 28);
        return;
      }

      const minY = Math.min(...candles.map((entry) => entry.low));
      const maxY = Math.max(...candles.map((entry) => entry.high));
      const range = Math.max(maxY - minY, 0.0001);
      const padLeft = 56;
      const padRight = 14;
      const padTop = 16;
      const padBottom = 34;
      const chartW = width - padLeft - padRight;
      const chartH = height - padTop - padBottom;

      const xFromIndex = (index) => padLeft + (index / Math.max(candles.length - 1, 1)) * chartW;
      const yFromValue = (value) => padTop + ((maxY - value) / range) * chartH;

      ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i += 1) {
        const y = padTop + (chartH / 4) * i;
        const value = maxY - (range * i / 4);
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(width - padRight, y);
        ctx.stroke();

        ctx.fillStyle = 'rgba(184, 195, 220, 0.9)';
        ctx.font = '11px Inter';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(value.toFixed(2), 8, y);
      }

      const xTicks = 4;
      for (let i = 0; i <= xTicks; i += 1) {
        const normalized = i / xTicks;
        const x = padLeft + normalized * chartW;
        ctx.beginPath();
        ctx.moveTo(x, padTop);
        ctx.lineTo(x, padTop + chartH);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.06)';
        ctx.stroke();

        const index = Math.min(candles.length - 1, Math.round(normalized * (candles.length - 1)));
        const label = candles[index]?.label || '-';
        ctx.fillStyle = 'rgba(184, 195, 220, 0.9)';
        ctx.font = '10px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(label, x, padTop + chartH + 6);
      }

      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 1.1;
      ctx.beginPath();
      ctx.moveTo(padLeft, padTop);
      ctx.lineTo(padLeft, padTop + chartH);
      ctx.lineTo(width - padRight, padTop + chartH);
      ctx.stroke();

      ctx.fillStyle = 'rgba(184, 195, 220, 0.95)';
      ctx.font = '11px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText('Time', padLeft + chartW / 2, height - 2);

      ctx.save();
      ctx.translate(14, padTop + chartH / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('Price Index', 0, 0);
      ctx.restore();

      const slot = chartW / candles.length;
      const bodyW = Math.max(4, slot * 0.56);

      candles.forEach((candle, index) => {
        const x = candles.length > 1 ? xFromIndex(index) : padLeft + chartW / 2;
        const yOpen = yFromValue(candle.open);
        const yClose = yFromValue(candle.close);
        const yHigh = yFromValue(candle.high);
        const yLow = yFromValue(candle.low);
        const bullish = candle.close >= candle.open;

        ctx.strokeStyle = bullish ? '#2dd4bf' : '#fb7185';
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(x, yHigh);
        ctx.lineTo(x, yLow);
        ctx.stroke();

        const top = Math.min(yOpen, yClose);
        const bodyH = Math.max(Math.abs(yClose - yOpen), 1.3);
        ctx.fillStyle = bullish ? '#2dd4bf' : '#fb7185';
        ctx.fillRect(x - bodyW / 2, top, bodyW, bodyH);
      });
    }

    function drawProfitSeries(canvasId, points) {
      const canvas = document.getElementById(canvasId);
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext('2d');
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      const width = rect.width;
      const height = rect.height;

      ctx.fillStyle = '#0d1222';
      ctx.fillRect(0, 0, width, height);

      if (!points.length) {
        ctx.fillStyle = '#98a2b8';
        ctx.font = '13px Inter';
        ctx.fillText('No profit series yet', 16, 28);
        return;
      }

      const values = points.map((point) => Number(point.cumulativePnl || 0));
      const minY = Math.min(...values, 0);
      const maxY = Math.max(...values, 0);
      const range = Math.max(maxY - minY, 0.0001);
      const padLeft = 64;
      const padRight = 14;
      const padTop = 16;
      const padBottom = 34;
      const chartW = width - padLeft - padRight;
      const chartH = height - padTop - padBottom;

      const getX = (index) => {
        if (points.length === 1) return padLeft + chartW / 2;
        return padLeft + (index / (points.length - 1)) * chartW;
      };

      const getY = (value) => padTop + ((maxY - value) / range) * chartH;

      ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i += 1) {
        const y = padTop + (chartH / 4) * i;
        const value = maxY - (range * i / 4);
        ctx.beginPath();
        ctx.moveTo(padLeft, y);
        ctx.lineTo(width - padRight, y);
        ctx.stroke();

        ctx.fillStyle = 'rgba(184, 195, 220, 0.9)';
        ctx.font = '11px Inter';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(value.toFixed(4), 8, y);
      }

      const xTicks = 4;
      for (let i = 0; i <= xTicks; i += 1) {
        const normalized = i / xTicks;
        const x = padLeft + normalized * chartW;
        ctx.beginPath();
        ctx.moveTo(x, padTop);
        ctx.lineTo(x, padTop + chartH);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.06)';
        ctx.stroke();

        const index = Math.min(points.length - 1, Math.round(normalized * (points.length - 1)));
        const label = String(points[index]?.sequence || index + 1);
        ctx.fillStyle = 'rgba(184, 195, 220, 0.9)';
        ctx.font = '10px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(label, x, padTop + chartH + 6);
      }

      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 1.1;
      ctx.beginPath();
      ctx.moveTo(padLeft, padTop);
      ctx.lineTo(padLeft, padTop + chartH);
      ctx.lineTo(width - padRight, padTop + chartH);
      ctx.stroke();

      const zeroLineY = getY(0);
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.beginPath();
      ctx.moveTo(padLeft, zeroLineY);
      ctx.lineTo(width - padRight, zeroLineY);
      ctx.stroke();

      ctx.beginPath();
      points.forEach((point, index) => {
        const x = getX(index);
        const y = getY(Number(point.cumulativePnl || 0));
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      const lastValue = Number(points[points.length - 1]?.cumulativePnl || 0);
      const positive = lastValue >= 0;
      ctx.strokeStyle = positive ? '#2dd4bf' : '#fb7185';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.fillStyle = 'rgba(184, 195, 220, 0.95)';
      ctx.font = '11px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText('Trade #', padLeft + chartW / 2, height - 2);

      ctx.save();
      ctx.translate(14, padTop + chartH / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('Cumulative PnL (SOL)', 0, 0);
      ctx.restore();
    }

    async function fetchJson(path, fallback) {
      await resolveApiBase();
      try {
        const response = await fetch(buildApiUrl(path), {
          cache: 'no-store',
          mode: 'cors',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        if (!response.ok) return fallback;
        return await response.json();
      } catch {
        return fallback;
      }
    }

    function updateApiSyncStatus({ ok, source = 'unknown', note = '' }) {
      const target = document.getElementById('apiSyncStatus');
      if (!target) return;

      if (ok) {
        lastApiSync = new Date();
      }

      const syncTime = lastApiSync ? lastApiSync.toLocaleTimeString() : 'never';
      const state = ok ? 'LIVE' : 'DEGRADED';
      const suffix = note ? ` | ${note}` : '';
      target.textContent = `API sync: ${state} | source: ${source} | last update: ${syncTime}${suffix}`;
    }

    function updateHeartbeatStatus(payload) {
      const target = document.getElementById('heartbeatStatus');
      if (!target) return;

      if (!payload?.ok || !payload?.heartbeat) {
        target.textContent = 'Heartbeat: unavailable';
        return;
      }

      const heartbeat = payload.heartbeat;
      const heartbeatTime = heartbeat?.fetchedAt
        ? new Date(heartbeat.fetchedAt).toLocaleTimeString()
        : 'unknown';
      const agentStatus = heartbeat?.agent?.status || 'unknown';
      const projectStatus = heartbeat?.project?.status || 'unknown';

      target.textContent = `Heartbeat: ${agentStatus} | project: ${projectStatus} | synced: ${heartbeatTime}`;
    }

    function renderPositions(positionRows) {
      const rows = positionRows.slice(0, 20).map((position) => {
        const symbol = position.symbol || mapSymbol(position.strategy);
        const pnl = Number(position.pnl || 0);
        const pnlClass = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
        const status = String(position.status || 'Closed');
        const isOpen = status.toLowerCase() === 'open';
        const statusClass = isOpen ? 'status-open' : 'status-closed';
        const statusLabel = `${isOpen ? 'Open ðŸŸ¢' : 'Closed ðŸ”´'}`;
        const timestamp = position.timestamp || position.createdAt;

        return `
          <tr>
            <td>${position.id}</td>
            <td>${symbol}</td>
            <td>${position.strategy}</td>
            <td>${Number(position.amount || position.sizeSol || 0).toFixed(2)} SOL</td>
            <td class="${pnlClass}">${formatSigned(pnl)} SOL</td>
            <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
            <td>${timestamp ? new Date(timestamp).toLocaleTimeString() : '-'}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('positionsBody').innerHTML = rows || `
        <tr>
          <td colspan="7" style="color:#98a2b8;">No positions in current runtime state.</td>
        </tr>
      `;
    }

    function renderMetrics(trades, votes, walletStats) {
      const totalTrades = trades.length;
      const totalPnL = trades.reduce((sum, trade) => sum + Number(trade.pnl || 0), 0);
      const wins = trades.filter((trade) => Number(trade.pnl || 0) > 0).length;
      const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
      const sharpe = computeSharpe(trades);
      const pnlText = `${formatSigned(totalPnL)} SOL`;
      const allowanceSol = Number(walletStats?.virtualWallet?.allowanceSol || 0);
      const currentBalanceSol = Number(walletStats?.virtualWallet?.currentBalanceSol || allowanceSol + totalPnL);
      const roiPct = Number(walletStats?.virtualWallet?.roiPct || 0);
      const totalVolumeSol = Number(walletStats?.trading?.totalVolumeSol || 0);
      const avgPnlSol = Number(walletStats?.trading?.avgPnlSol || 0);

      document.getElementById('headerPnL').textContent = pnlText;
      document.getElementById('headerWalletBalance').textContent = `${currentBalanceSol.toFixed(4)} SOL`;
      document.getElementById('headerVotes').textContent = String(Number(votes || 0));
      document.getElementById('cardPnL').textContent = pnlText;
      document.getElementById('cardWinRate').textContent = `${winRate.toFixed(1)}%`;
      document.getElementById('cardSharpe').textContent = sharpe.toFixed(2);
      document.getElementById('cardTotalTrades').textContent = String(totalTrades);
      document.getElementById('cardWinningTrades').textContent = String(wins);
      document.getElementById('cardVotes').textContent = String(Number(votes || 0));
      document.getElementById('cardWalletAllowance').textContent = `${allowanceSol.toFixed(4)} SOL`;
      document.getElementById('cardWalletBalance').textContent = `${currentBalanceSol.toFixed(4)} SOL`;
      document.getElementById('cardWalletRoi').textContent = formatPercent(roiPct);
      document.getElementById('cardTradeVolume').textContent = `${totalVolumeSol.toFixed(4)} SOL`;
      document.getElementById('cardAvgPnl').textContent = `${formatSigned(avgPnlSol)} SOL`;

      document.getElementById('cardPnL').className = `metric-value ${totalPnL >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
      document.getElementById('cardWalletBalance').className = `metric-value ${currentBalanceSol >= allowanceSol ? 'pnl-pos' : 'pnl-neg'}`;
      document.getElementById('cardWalletRoi').className = `metric-value ${roiPct >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
      document.getElementById('cardAvgPnl').className = `metric-value ${avgPnlSol >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
      document.title = `Helios Synerga | PnL ${formatSigned(totalPnL)} SOL | Votes ${Number(votes || 0)}`;
    }

    function renderForumConversations(forumRows) {
      const rows = forumRows.slice(0, 20).map((item) => {
        const type = String(item.type || 'comment').toLowerCase();
        const reference = item.reference || item.commentId || item.postId || item.id || '-';
        const message = String(item.content || item.message || '-')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        const timestamp = item.createdAt || item.timestamp;
        const isPost = type === 'post';
        const typeLabel = isPost ? 'Post' : 'Comment';
        const pillClass = isPost ? 'forum-pill-post' : 'forum-pill-comment';

        return `
          <tr>
            <td><span class="status-pill ${pillClass}">${typeLabel}</span></td>
            <td>${reference}</td>
            <td>${message.slice(0, 84)}</td>
            <td>${timestamp ? new Date(timestamp).toLocaleTimeString() : '-'}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('forumBody').innerHTML = rows || `
        <tr>
          <td colspan="4" style="color:#98a2b8;">No forum conversations captured yet.</td>
        </tr>
      `;
    }

    async function refreshDashboard() {
      const [trades, livePositionsPayload, forumConversationsPayload, votesPayload, heartbeatPayload, walletStatsPayload, pnlSeriesPayload, tradingSettingsPayload] = await Promise.all([
        fetchJson('/api/trades', []),
        fetchJson('/api/positions-live', { items: [] }),
        fetchJson('/api/forum-conversations', { items: [] }),
        fetchJson('/api/colosseum-votes', { votes: 0 }),
        fetchJson('/api/heartbeat', { ok: false }),
        fetchJson('/api/wallet-stats', {
          virtualWallet: {
            allowanceSol: 0,
            currentBalanceSol: 0,
            roiPct: 0
          },
          trading: {
            totalVolumeSol: 0,
            avgPnlSol: 0
          }
        }),
        fetchJson('/api/pnl-series', { points: [] }),
        fetchJson('/api/trading-settings', {
          tradingMode: 'virtual-wallet',
          allowanceSource: 'unknown'
        })
      ]);

      const votes = Number(votesPayload?.votes || 0);
      const apiSource = votesPayload?.source || 'unknown';
      const degraded = Boolean(votesPayload?.error);
      const livePositions = Array.isArray(livePositionsPayload?.items)
        ? livePositionsPayload.items
        : [];
      const forumConversations = Array.isArray(forumConversationsPayload?.items)
        ? forumConversationsPayload.items
        : [];

      renderMetrics(trades, votes, walletStatsPayload);
      renderPositions(livePositions);
      renderForumConversations(forumConversations);

      const btcCandles = buildCandlesFromTrades(trades, 'BTCUSDT');
      const solCandles = buildCandlesFromTrades(trades, 'SOLUSDT');
      const pnlSeries = Array.isArray(pnlSeriesPayload?.points) ? pnlSeriesPayload.points.slice(-120) : [];
      drawCandles('btcChart', btcCandles);
      drawCandles('solChart', solCandles);
      drawProfitSeries('profitChart', pnlSeries);

      updateApiSyncStatus({
        ok: !degraded,
        source: apiSource,
        note: `${degraded ? 'votes fallback active | ' : ''}${tradingSettingsPayload?.tradingMode || 'mode:unknown'} | wallet:${tradingSettingsPayload?.allowanceSource || 'unknown'} | api:${resolvedApiBase || window.location.origin}`
      });

      updateHeartbeatStatus(heartbeatPayload);
    }

    refreshDashboard();
    setInterval(refreshDashboard, 5000);

    window.addEventListener('resize', () => {
      refreshDashboard();
    });
  </script>
</body>
</html>
