<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helios Synerga | LIVE Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cruip-bg: #0b0e1b;
      --cruip-card: rgba(15, 23, 43, 0.75);
      --cruip-glass: rgba(255, 255, 255, 0.03);
      --cruip-border: rgba(255, 255, 255, 0.08);
      --cruip-text: #e6eaf2;
      --cruip-muted: #98a2b8;
      --cruip-green: #2dd4bf;
      --cruip-red: #fb7185;
      --cruip-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --radius-xl: 20px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      min-height: 100%;
      background: radial-gradient(circle at 15% 10%, #1a2444 0%, var(--cruip-bg) 40%, #080b14 100%);
      color: var(--cruip-text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dashboard {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 2rem;
      padding: 1.5rem;
    }

    .glass-panel {
      background: var(--cruip-card);
      border: 1px solid var(--cruip-border);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      flex-wrap: wrap;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      font-size: 1.1rem;
    }

    .live-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border: 1px solid rgba(45, 212, 191, 0.45);
      color: #99f6e4;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: rgba(45, 212, 191, 0.08);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--cruip-green);
      box-shadow: 0 0 0 8px rgba(45, 212, 191, 0.12);
    }

    .header-stats {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-stat {
      min-width: 150px;
      padding: 0.55rem 0.75rem;
      border-radius: 12px;
      border: 1px solid var(--cruip-border);
      background: var(--cruip-glass);
    }

    .label {
      color: var(--cruip-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.66rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .header-value {
      font-weight: 800;
      font-size: 1.15rem;
      line-height: 1;
    }

    .main-grid {
      display: grid;
      grid-template-rows: minmax(420px, 50%) minmax(260px, 25%) minmax(260px, 25%);
      gap: 1.25rem;
      min-height: 0;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      min-height: 0;
    }

    .chart-card {
      background: var(--cruip-card);
      border-radius: var(--radius-xl);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
      border: 1px solid var(--cruip-border);
      display: flex;
      flex-direction: column;
      padding: 0.95rem;
      min-height: 0;
    }

    .chart-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
    }

    .chart-title {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .chart-subtitle {
      color: var(--cruip-muted);
      font-size: 0.72rem;
      font-weight: 500;
    }

    .chart-canvas-wrap {
      height: 400px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      overflow: hidden;
      background: #0d1222;
    }

    .chart-canvas-wrap canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 0.85rem;
    }

    .metric-card {
      background: var(--cruip-card);
      border: 1px solid var(--cruip-border);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      box-shadow: var(--cruip-shadow);
      padding: 0.85rem;
      min-height: 112px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
    }

    .metric-value {
      font-size: clamp(1.05rem, 1.8vw, 1.6rem);
      font-weight: 800;
      line-height: 1.1;
    }

    .bottom-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      min-height: 0;
    }

    .table-card {
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .table-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--cruip-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.65rem;
    }

    .table-wrap {
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: rgba(11, 16, 32, 0.7);
      overflow: auto;
      flex: 1;
      min-height: 190px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.76rem;
    }

    th,
    td {
      text-align: left;
      padding: 0.55rem 0.55rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      white-space: nowrap;
    }

    th {
      color: var(--cruip-muted);
      font-size: 0.63rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      position: sticky;
      top: 0;
      background: rgba(8, 12, 24, 0.96);
      z-index: 1;
    }

    .pnl-pos { color: var(--cruip-green); }
    .pnl-neg { color: var(--cruip-red); }

    .status-pill {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid var(--cruip-border);
      padding: 0.15rem 0.48rem;
      font-size: 0.64rem;
      color: #cfd7e8;
      background: rgba(255, 255, 255, 0.03);
    }

    .footer {
      text-align: center;
      color: var(--cruip-muted);
      font-size: 0.78rem;
      padding-bottom: 0.5rem;
    }

    .footer a {
      color: #b8c3dc;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 1280px) {
      .metrics-grid {
        grid-template-columns: repeat(3, minmax(130px, 1fr));
      }

      .main-grid {
        grid-template-rows: auto auto auto;
      }
    }

    @media (max-width: 980px) {
      .dashboard {
        padding: 1rem;
        gap: 1rem;
      }

      .charts-grid,
      .bottom-grid {
        grid-template-columns: 1fr;
      }

      .chart-canvas-wrap {
        height: 320px;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, minmax(130px, 1fr));
      }

      .header-stat {
        min-width: 130px;
      }
    }

    @media (max-width: 620px) {
      .header {
        align-items: flex-start;
      }

      .header-stats {
        width: 100%;
      }

      .header-stat {
        width: 100%;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <header class="header glass-panel">
      <div class="header-brand">
        <span>Helios Synerga</span>
        <span class="live-pill"><span class="live-dot"></span>LIVE</span>
      </div>
      <div class="header-stats">
        <div class="header-stat">
          <div class="label">Real P&amp;L</div>
          <div id="headerPnL" class="header-value">+0.0000 SOL</div>
        </div>
        <div class="header-stat">
          <div class="label">Real Votes</div>
          <div id="headerVotes" class="header-value">0</div>
        </div>
      </div>
    </header>

    <section class="main-grid">
      <section class="charts-grid">
        <article class="chart-card">
          <div class="chart-head">
            <div class="chart-title">BTCUSDT</div>
            <div class="chart-subtitle">Real trade ticks</div>
          </div>
          <div class="chart-canvas-wrap">
            <canvas id="btcChart"></canvas>
          </div>
        </article>
        <article class="chart-card">
          <div class="chart-head">
            <div class="chart-title">SOLUSDT</div>
            <div class="chart-subtitle">Real trade ticks</div>
          </div>
          <div class="chart-canvas-wrap">
            <canvas id="solChart"></canvas>
          </div>
        </article>
      </section>

      <section class="metrics-grid">
        <article class="metric-card">
          <div class="label">PnL</div>
          <div id="cardPnL" class="metric-value">+0.0000 SOL</div>
        </article>
        <article class="metric-card">
          <div class="label">Win Rate</div>
          <div id="cardWinRate" class="metric-value">0.0%</div>
        </article>
        <article class="metric-card">
          <div class="label">Sharpe</div>
          <div id="cardSharpe" class="metric-value">0.00</div>
        </article>
        <article class="metric-card">
          <div class="label">Total Trades</div>
          <div id="cardTotalTrades" class="metric-value">0</div>
        </article>
        <article class="metric-card">
          <div class="label">Winning Trades</div>
          <div id="cardWinningTrades" class="metric-value">0</div>
        </article>
        <article class="metric-card">
          <div class="label">Vote Count</div>
          <div id="cardVotes" class="metric-value">0</div>
        </article>
      </section>

      <section class="bottom-grid">
        <article class="table-card glass-panel">
          <h3 class="table-title">Positions</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Symbol</th>
                  <th>Strategy</th>
                  <th>Size</th>
                  <th>PnL</th>
                  <th>Status</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="positionsBody"></tbody>
            </table>
          </div>
        </article>

        <article class="table-card glass-panel">
          <h3 class="table-title">Activity</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Reference</th>
                  <th>Content</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="activityBody"></tbody>
            </table>
          </div>
        </article>
      </section>
    </section>

    <footer class="footer">
      Technical details:
      <a href="https://github.com/Quantum-Synergi/HeliosSynerga" target="_blank" rel="noopener noreferrer">https://github.com/Quantum-Synergi/HeliosSynerga</a>
    </footer>
  </main>

  <script>
    function formatSigned(value) {
      const number = Number(value || 0);
      const sign = number >= 0 ? '+' : '';
      return `${sign}${number.toFixed(4)}`;
    }

    function computeSharpe(trades) {
      if (!trades.length) return 0;
      const returns = trades.map((trade) => Number(trade.pnl || 0));
      const mean = returns.reduce((sum, value) => sum + value, 0) / returns.length;
      const variance = returns.reduce((sum, value) => sum + ((value - mean) ** 2), 0) / returns.length;
      const stdDev = Math.sqrt(variance);
      if (!stdDev) return 0;
      return (mean / stdDev) * Math.sqrt(returns.length);
    }

    function mapSymbol(strategy) {
      return strategy === 'liquidity' ? 'SOLUSDT' : 'BTCUSDT';
    }

    function buildCandlesFromTrades(trades, symbol) {
      const strategyFilter = symbol === 'SOLUSDT'
        ? (trade) => trade.strategy === 'liquidity'
        : (trade) => trade.strategy !== 'liquidity';

      const selected = trades
        .filter(strategyFilter)
        .slice()
        .reverse();

      if (!selected.length) return [];

      let level = 100;
      const points = selected.map((trade, index) => {
        level += Number(trade.pnl || 0) * 10000;
        return {
          x: index,
          y: level,
          timestamp: trade.timestamp
        };
      });

      const candles = [];
      const step = 3;
      for (let index = 0; index < points.length; index += step) {
        const slice = points.slice(index, index + step);
        const open = slice[0].y;
        const close = slice[slice.length - 1].y;
        const high = Math.max(...slice.map((entry) => entry.y));
        const low = Math.min(...slice.map((entry) => entry.y));
        candles.push({
          open,
          close,
          high,
          low,
          label: new Date(slice[slice.length - 1].timestamp).toLocaleTimeString()
        });
      }

      return candles.slice(-40);
    }

    function drawCandles(canvasId, candles) {
      const canvas = document.getElementById(canvasId);
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext('2d');
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      const width = rect.width;
      const height = rect.height;

      ctx.fillStyle = '#0d1222';
      ctx.fillRect(0, 0, width, height);

      if (!candles.length) {
        ctx.fillStyle = '#98a2b8';
        ctx.font = '13px Inter';
        ctx.fillText('No trade ticks yet', 16, 28);
        return;
      }

      const minY = Math.min(...candles.map((entry) => entry.low));
      const maxY = Math.max(...candles.map((entry) => entry.high));
      const range = Math.max(maxY - minY, 0.0001);
      const padX = 18;
      const padY = 16;
      const chartW = width - padX * 2;
      const chartH = height - padY * 2;

      ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i += 1) {
        const y = padY + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padX, y);
        ctx.lineTo(width - padX, y);
        ctx.stroke();
      }

      const slot = chartW / candles.length;
      const bodyW = Math.max(4, slot * 0.56);

      candles.forEach((candle, index) => {
        const x = padX + slot * index + slot / 2;
        const yOpen = padY + ((maxY - candle.open) / range) * chartH;
        const yClose = padY + ((maxY - candle.close) / range) * chartH;
        const yHigh = padY + ((maxY - candle.high) / range) * chartH;
        const yLow = padY + ((maxY - candle.low) / range) * chartH;
        const bullish = candle.close >= candle.open;

        ctx.strokeStyle = bullish ? '#2dd4bf' : '#fb7185';
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(x, yHigh);
        ctx.lineTo(x, yLow);
        ctx.stroke();

        const top = Math.min(yOpen, yClose);
        const bodyH = Math.max(Math.abs(yClose - yOpen), 1.3);
        ctx.fillStyle = bullish ? '#2dd4bf' : '#fb7185';
        ctx.fillRect(x - bodyW / 2, top, bodyW, bodyH);
      });
    }

    async function fetchJson(url, fallback) {
      try {
        const response = await fetch(url);
        if (!response.ok) return fallback;
        return await response.json();
      } catch {
        return fallback;
      }
    }

    function renderPositions(trades) {
      const rows = trades.slice(0, 20).map((trade) => {
        const symbol = mapSymbol(trade.strategy);
        const pnl = Number(trade.pnl || 0);
        const pnlClass = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';

        return `
          <tr>
            <td>${trade.id}</td>
            <td>${symbol}</td>
            <td>${trade.strategy}</td>
            <td>${Number(trade.amount || 0).toFixed(2)} SOL</td>
            <td class="${pnlClass}">${formatSigned(pnl)} SOL</td>
            <td><span class="status-pill">SIMULATED_FILL</span></td>
            <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('positionsBody').innerHTML = rows || `
        <tr>
          <td colspan="7" style="color:#98a2b8;">No positions in current runtime state.</td>
        </tr>
      `;
    }

    function renderActivity(activityRows) {
      const rows = activityRows.slice(0, 20).map((item) => {
        const reference = item.postId || item.commentId || '-';
        const content = String(item.content || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const time = new Date(item.createdAt).toLocaleTimeString();
        return `
          <tr>
            <td>${item.type || '-'}</td>
            <td>${reference}</td>
            <td>${content.slice(0, 72)}</td>
            <td>${time}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('activityBody').innerHTML = rows || `
        <tr>
          <td colspan="4" style="color:#98a2b8;">No activity captured yet.</td>
        </tr>
      `;
    }

    function renderMetrics(trades, votes) {
      const totalTrades = trades.length;
      const totalPnL = trades.reduce((sum, trade) => sum + Number(trade.pnl || 0), 0);
      const wins = trades.filter((trade) => Number(trade.pnl || 0) > 0).length;
      const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
      const sharpe = computeSharpe(trades);
      const pnlText = `${formatSigned(totalPnL)} SOL`;

      document.getElementById('headerPnL').textContent = pnlText;
      document.getElementById('headerVotes').textContent = String(Number(votes || 0));
      document.getElementById('cardPnL').textContent = pnlText;
      document.getElementById('cardWinRate').textContent = `${winRate.toFixed(1)}%`;
      document.getElementById('cardSharpe').textContent = sharpe.toFixed(2);
      document.getElementById('cardTotalTrades').textContent = String(totalTrades);
      document.getElementById('cardWinningTrades').textContent = String(wins);
      document.getElementById('cardVotes').textContent = String(Number(votes || 0));

      document.getElementById('cardPnL').className = `metric-value ${totalPnL >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
      document.title = `Helios Synerga | PnL ${formatSigned(totalPnL)} SOL | Votes ${Number(votes || 0)}`;
    }

    async function refreshDashboard() {
      const [trades, votesPayload, forumActivity] = await Promise.all([
        fetchJson('/api/trades', []),
        fetchJson('/api/colosseum-votes', { votes: 0 }),
        fetchJson('/api/forum', [])
      ]);

      const votes = Number(votesPayload?.votes || 0);
      renderMetrics(trades, votes);
      renderPositions(trades);
      renderActivity(forumActivity);

      const btcCandles = buildCandlesFromTrades(trades, 'BTCUSDT');
      const solCandles = buildCandlesFromTrades(trades, 'SOLUSDT');
      drawCandles('btcChart', btcCandles);
      drawCandles('solChart', solCandles);
    }

    refreshDashboard();
    setInterval(refreshDashboard, 5000);

    window.addEventListener('resize', () => {
      refreshDashboard();
    });
  </script>
</body>
</html>
