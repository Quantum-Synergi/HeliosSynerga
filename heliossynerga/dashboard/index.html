<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QANTUMSYNERGI Enterprise Trading Terminal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg0: #0a0e1a;
      --bg1: #1a1f2e;
      --panel: rgba(26, 31, 46, 0.9);
      --panel-soft: rgba(20, 24, 36, 0.75);
      --border: rgba(255, 255, 255, 0.1);
      --text: #e8edf7;
      --muted: #93a0b8;
      --accent: #4dd4a0;
      --danger: #ff5f6d;
      --warn: #f7b955;
      --shadow: 0 32px 64px rgba(0, 0, 0, 0.4);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .trading-terminal {
      display: grid;
      grid-template-areas:
        "header header"
        "charts charts"
        "metrics positions";
      grid-template-columns: 3fr 4fr;
      grid-template-rows: 80px 70vh minmax(220px, 1fr);
      height: 100vh;
      gap: 24px;
      padding: 24px;
    }

    .glass {
      backdrop-filter: blur(20px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .header {
      grid-area: header;
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      letter-spacing: 0.4px;
      font-size: 22px;
    }

    .live-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 8px rgba(77, 212, 160, 0.14);
    }

    .header-metrics {
      display: flex;
      align-items: center;
      gap: 28px;
      font-weight: 600;
    }

    .header-metrics span {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      display: block;
      margin-bottom: 3px;
    }

    .header-metrics strong {
      font-size: 22px;
      color: var(--text);
      font-weight: 800;
    }

    .charts {
      grid-area: charts;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .chart-panel {
      padding: 16px;
      display: flex;
      flex-direction: column;
      background: #0f141f;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .chart-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .chart-head small {
      color: var(--muted);
      font-weight: 500;
      font-size: 12px;
    }

    canvas {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: #0f141f;
    }

    .metrics {
      grid-area: metrics;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-content: start;
    }

    .metric-card {
      backdrop-filter: blur(20px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      min-height: 118px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.28);
    }

    .metric-label {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .metric-value {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 800;
      line-height: 1;
    }

    .positions {
      grid-area: positions;
      padding: 14px;
      overflow: hidden;
    }

    .positions h3 {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow: hidden;
    }

    th,
    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding: 10px 8px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      color: var(--muted);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      position: sticky;
      top: 0;
      background: rgba(15, 20, 31, 0.92);
    }

    .table-wrap {
      max-height: 100%;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(15, 20, 31, 0.5);
    }

    .pnl-pos { color: var(--accent); font-weight: 700; }
    .pnl-neg { color: var(--danger); font-weight: 700; }
    .status-pill {
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      color: #d6deef;
      display: inline-block;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 1100px) {
      .trading-terminal {
        grid-template-areas:
          "header"
          "charts"
          "metrics"
          "positions";
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto 1fr;
        height: auto;
        min-height: 100vh;
      }

      .charts {
        grid-template-columns: 1fr;
      }

      .chart-panel {
        min-height: 320px;
      }

      .metrics {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 700px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .header-metrics {
        gap: 16px;
      }

      .metrics {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="trading-terminal">
    <header class="header glass">
      <div class="brand">
        <span>QANTUMSYNERGI</span>
        <span class="live-dot"></span>
        <span class="muted">LIVE</span>
      </div>
      <div class="header-metrics">
        <div>
          <span>Total PnL</span>
          <strong id="headerPnL">0.0000 SOL</strong>
        </div>
        <div>
          <span>Win Rate</span>
          <strong id="headerWinRate">0.0%</strong>
        </div>
      </div>
    </header>

    <section class="charts">
      <article class="chart-panel">
        <div class="chart-head">
          <div>BTCUSDT</div>
          <small>Candlestick-style from real bot trade ticks</small>
        </div>
        <canvas id="btcChart"></canvas>
      </article>
      <article class="chart-panel">
        <div class="chart-head">
          <div>SOLUSDT</div>
          <small>Candlestick-style from real bot trade ticks</small>
        </div>
        <canvas id="solChart"></canvas>
      </article>
    </section>

    <section class="metrics">
      <article class="metric-card">
        <div class="metric-label">PnL</div>
        <div id="cardPnL" class="metric-value">0.0000</div>
      </article>
      <article class="metric-card">
        <div class="metric-label">Win Rate</div>
        <div id="cardWinRate" class="metric-value">0.0%</div>
      </article>
      <article class="metric-card">
        <div class="metric-label">Sharpe</div>
        <div id="cardSharpe" class="metric-value">0.00</div>
      </article>
      <article class="metric-card">
        <div class="metric-label">Vote Count</div>
        <div id="cardVotes" class="metric-value">0</div>
      </article>
    </section>

    <section class="positions glass">
      <h3>My Open Trades / Positions (Real Feed)</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Symbol</th>
              <th>Strategy</th>
              <th>Size (SOL)</th>
              <th>PnL</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="positionsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    function formatSigned(value) {
      const number = Number(value || 0);
      const sign = number >= 0 ? '+' : '';
      return `${sign}${number.toFixed(4)}`;
    }

    function computeSharpe(trades) {
      if (!trades.length) return 0;
      const returns = trades.map(t => Number(t.pnl || 0));
      const mean = returns.reduce((sum, x) => sum + x, 0) / returns.length;
      const variance = returns.reduce((sum, x) => sum + ((x - mean) ** 2), 0) / returns.length;
      const stdDev = Math.sqrt(variance);
      if (stdDev === 0) return 0;
      return (mean / stdDev) * Math.sqrt(returns.length);
    }

    function mapSymbol(strategy) {
      if (strategy === 'liquidity') return 'SOLUSDT';
      return 'BTCUSDT';
    }

    function buildCandlesFromTrades(trades, symbol) {
      const strategyFilter = symbol === 'SOLUSDT'
        ? t => t.strategy === 'liquidity'
        : t => t.strategy !== 'liquidity';

      const selected = trades
        .filter(strategyFilter)
        .slice()
        .reverse();

      if (!selected.length) return [];

      let level = 100;
      const points = selected.map((trade, index) => {
        level += Number(trade.pnl || 0) * 10000;
        return {
          x: index,
          y: level,
          timestamp: trade.timestamp
        };
      });

      const candles = [];
      const step = 3;
      for (let i = 0; i < points.length; i += step) {
        const slice = points.slice(i, i + step);
        const open = slice[0].y;
        const close = slice[slice.length - 1].y;
        const high = Math.max(...slice.map(s => s.y));
        const low = Math.min(...slice.map(s => s.y));
        candles.push({
          open,
          close,
          high,
          low,
          label: new Date(slice[slice.length - 1].timestamp).toLocaleTimeString()
        });
      }

      return candles.slice(-40);
    }

    function drawCandles(canvasId, candles) {
      const canvas = document.getElementById(canvasId);
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);

      const ctx = canvas.getContext('2d');
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      const width = rect.width;
      const height = rect.height;

      ctx.fillStyle = '#0f141f';
      ctx.fillRect(0, 0, width, height);

      if (!candles.length) {
        ctx.fillStyle = '#93a0b8';
        ctx.font = '14px Inter';
        ctx.fillText('No trade ticks yet', 16, 28);
        return;
      }

      const minY = Math.min(...candles.map(c => c.low));
      const maxY = Math.max(...candles.map(c => c.high));
      const range = Math.max(maxY - minY, 0.0001);

      const padX = 24;
      const padY = 20;
      const chartW = width - padX * 2;
      const chartH = height - padY * 2;

      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padY + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padX, y);
        ctx.lineTo(width - padX, y);
        ctx.stroke();
      }

      const slot = chartW / candles.length;
      const bodyW = Math.max(4, slot * 0.56);

      candles.forEach((candle, idx) => {
        const x = padX + slot * idx + slot / 2;
        const yOpen = padY + (maxY - candle.open) / range * chartH;
        const yClose = padY + (maxY - candle.close) / range * chartH;
        const yHigh = padY + (maxY - candle.high) / range * chartH;
        const yLow = padY + (maxY - candle.low) / range * chartH;
        const bullish = candle.close >= candle.open;

        ctx.strokeStyle = bullish ? '#4dd4a0' : '#ff5f6d';
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(x, yHigh);
        ctx.lineTo(x, yLow);
        ctx.stroke();

        const top = Math.min(yOpen, yClose);
        const bodyH = Math.max(Math.abs(yClose - yOpen), 1.4);
        ctx.fillStyle = bullish ? '#4dd4a0' : '#ff5f6d';
        ctx.fillRect(x - bodyW / 2, top, bodyW, bodyH);
      });
    }

    async function fetchJson(url, fallback) {
      try {
        const response = await fetch(url);
        if (!response.ok) return fallback;
        return await response.json();
      } catch {
        return fallback;
      }
    }

    function renderPositions(trades) {
      const rows = trades.slice(0, 20).map((trade) => {
        const symbol = mapSymbol(trade.strategy);
        const pnl = Number(trade.pnl || 0);
        const pnlClass = pnl >= 0 ? 'pnl-pos' : 'pnl-neg';
        return `
          <tr>
            <td>${trade.id}</td>
            <td>${symbol}</td>
            <td>${trade.strategy}</td>
            <td>${Number(trade.amount || 0).toFixed(2)}</td>
            <td class="${pnlClass}">${formatSigned(pnl)} SOL</td>
            <td><span class="status-pill">SIMULATED_FILL</span></td>
            <td>${new Date(trade.timestamp).toLocaleTimeString()}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('positionsBody').innerHTML = rows || `
        <tr>
          <td colspan="7" class="muted">No position rows in current runtime state.</td>
        </tr>
      `;
    }

    function renderMetrics(trades, votes) {
      const totalTrades = trades.length;
      const totalPnL = trades.reduce((sum, t) => sum + Number(t.pnl || 0), 0);
      const wins = trades.filter(t => Number(t.pnl || 0) > 0).length;
      const winRate = totalTrades ? (wins / totalTrades) * 100 : 0;
      const sharpe = computeSharpe(trades);

      const pnlText = `${formatSigned(totalPnL)} SOL`;
      document.getElementById('headerPnL').textContent = pnlText;
      document.getElementById('headerWinRate').textContent = `${winRate.toFixed(1)}%`;
      document.getElementById('cardPnL').textContent = pnlText;
      document.getElementById('cardWinRate').textContent = `${winRate.toFixed(1)}%`;
      document.getElementById('cardSharpe').textContent = sharpe.toFixed(2);
      document.getElementById('cardVotes').textContent = String(Number(votes || 0));

      document.getElementById('cardPnL').className = `metric-value ${totalPnL >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
      document.title = `QANTUMSYNERGI | PnL ${formatSigned(totalPnL)} SOL | WR ${winRate.toFixed(1)}%`;
    }

    async function refreshDashboard() {
      const [trades, votesPayload] = await Promise.all([
        fetchJson('/api/trades', []),
        fetchJson('/api/colosseum-votes', { votes: 0 })
      ]);

      const votes = Number(votesPayload?.votes || 0);
      renderMetrics(trades, votes);
      renderPositions(trades);

      const btcCandles = buildCandlesFromTrades(trades, 'BTCUSDT');
      const solCandles = buildCandlesFromTrades(trades, 'SOLUSDT');
      drawCandles('btcChart', btcCandles);
      drawCandles('solChart', solCandles);
    }

    refreshDashboard();
    setInterval(refreshDashboard, 5000);
    setInterval(async () => {
      const votesPayload = await fetchJson('/api/colosseum-votes', { votes: 0 });
      document.getElementById('cardVotes').textContent = String(Number(votesPayload?.votes || 0));
    }, 15000);

    window.addEventListener('resize', () => {
      refreshDashboard();
    });
  </script>
</body>
</html>